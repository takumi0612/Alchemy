import React, { useState, useEffect, useCallback } from 'react';
import { 
  FlaskConical, 
  Sparkles, 
  Coins, 
  Scroll, 
  ShoppingBag, 
  Wand2, 
  FlameKindling,
  History,
  TrendingUp,
  ArrowRightLeft,
  Skull,
  Leaf,
  ShieldAlert,
  ChevronRight,
  User
} from 'lucide-react';

// --- ÂÆöÊï∞ÂÆöÁæ© ---
const RAW_MATERIALS = [
  { id: 'red_herb', name: 'Ëµ§„ÅÆËñ¨Ëçâ', basePrice: 40, icon: 'üåø', color: 'text-emerald-500' },
  { id: 'blue_herb', name: 'Èùí„ÅÆËñ¨Ëçâ', basePrice: 60, icon: 'üå±', color: 'text-cyan-500' },
  { id: 'monster_claw', name: 'È≠îÁâ©„ÅÆÁà™', basePrice: 150, icon: 'ü¶¥', color: 'text-orange-700' },
  { id: 'magic_water', name: 'È≠îÂäõÊ∞¥', basePrice: 100, icon: 'üíß', color: 'text-blue-400' },
];

const CRAFTED_ITEMS = [
  { 
    id: 'hp_potion', 
    name: 'Áôí„ÇÑ„Åó„ÅÆ„Éù„Éº„Ç∑„Éß„É≥', 
    sellPrice: 250, 
    icon: 'üß™', 
    recipe: { red_herb: 2, magic_water: 1 },
    description: 'ÂÇ∑„ÇíÁôí„ÇÑ„ÅôÂü∫Êú¨„ÅÆËñ¨„ÄÇ'
  },
  { 
    id: 'mp_potion', 
    name: 'È≠îÂäõ„ÅÆ„Éù„Éº„Ç∑„Éß„É≥', 
    sellPrice: 350, 
    icon: '‚öóÔ∏è', 
    recipe: { blue_herb: 2, magic_water: 1 },
    description: 'È≠îÂäõ„ÇíÂõûÂæ©„Åï„Åõ„ÇãÈùí„ÅÑÈõ´„ÄÇ'
  },
  { 
    id: 'strength_elixir', 
    name: 'ÂâõÂäõ„ÅÆÈúäËñ¨', 
    sellPrice: 800, 
    icon: 'üç∑', 
    recipe: { monster_claw: 1, red_herb: 1, magic_water: 1 },
    description: '‰∏ÄÊôÇÁöÑ„Å´Á≠ãÂäõ„ÇíÂ§ßÂπÖ„Å´Âº∑Âåñ„Åô„Çã„ÄÇ'
  },
];

const UPGRADES = [
  { id: 'cauldron_v2', name: 'ÈäÄ„ÅÆÈå¨ÈáëÈáú', cost: 1500, description: 'Èå¨ÈáëÊôÇ„ÅÆÊàêÂäüÂ†±ÈÖ¨„Åå10%„Ç¢„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ' },
  { id: 'shop_sign', name: 'È≠îÊ≥ï„ÅÆÁúãÊùø', cost: 800, description: 'Êù•ÂÆ¢Áéá„Åå‰∏äÊòá„Åó„Åæ„Åô„ÄÇ' },
];

const App = () => {
  // --- Áä∂ÊÖãÁÆ°ÁêÜ ---
  const [money, setMoney] = useState(1000);
  const [day, setDay] = useState(1);
  const [inventory, setInventory] = useState({
    red_herb: 8, blue_herb: 5, monster_claw: 0, magic_water: 6,
    hp_potion: 0, mp_potion: 0, strength_elixir: 0
  });
  const [marketPrices, setMarketPrices] = useState({});
  const [logs, setLogs] = useState([]);
  const [activeTab, setActiveTab] = useState('shop');
  const [reputation, setReputation] = useState(30);
  const [ownedUpgrades, setOwnedUpgrades] = useState([]);
  const [customerQueue, setCustomerQueue] = useState([]);
  const [stats, setStats] = useState({ totalSales: 0, craftedCount: 0 });

  // --- ÂàùÊúüÂåñ & Êó•Êï∞ÁµåÈÅé ---
  useEffect(() => {
    const updatePrices = () => {
      const newPrices = {};
      RAW_MATERIALS.forEach(item => {
        const flux = 0.7 + Math.random() * 0.6;
        newPrices[item.id] = Math.floor(item.basePrice * flux);
      });
      setMarketPrices(newPrices);
    };
    updatePrices();
  }, [day]);

  const addLog = useCallback((msg, type = 'info') => {
    setLogs(prev => [{ id: Date.now(), msg, type, time: new Date().toLocaleTimeString() }, ...prev].slice(0, 30));
  }, []);

  // --- Êù•ÂÆ¢„É≠„Ç∏„ÉÉ„ÇØ ---
  useEffect(() => {
    const rate = ownedUpgrades.includes('shop_sign') ? 0.45 : 0.3;
    const interval = setInterval(() => {
      if (Math.random() < rate + (reputation / 250)) {
        const allPossible = [...RAW_MATERIALS, ...CRAFTED_ITEMS];
        const wanted = allPossible[Math.floor(Math.random() * allPossible.length)];
        setCustomerQueue(prev => [...prev, { 
          id: Date.now(), 
          want: wanted.id, 
          name: `ÂÜíÈô∫ËÄÖ ${['„Ç¢„É´„Çπ', '„Çº„Éé„É≥', '„É™„Éä', '„Ç´„Ç§„É´', '„Éü„É©', '„Éï„Ç°„É´', '„Ç∑„Ç™„É≥'][Math.floor(Math.random()*7)]} #${Math.floor(Math.random()*999)}` 
        }]);
      }
    }, 4500);
    return () => clearInterval(interval);
  }, [reputation, ownedUpgrades]);

  // --- Ë≤©Â£≤Âá¶ÁêÜ ---
  useEffect(() => {
    if (customerQueue.length > 0) {
      const customer = customerQueue[0];
      const timer = setTimeout(() => {
        const itemData = [...RAW_MATERIALS, ...CRAFTED_ITEMS].find(i => i.id === customer.want);
        
        if (inventory[customer.want] > 0) {
          const price = itemData.sellPrice || Math.floor(itemData.basePrice * 1.5);
          setInventory(prev => ({ ...prev, [customer.want]: prev[customer.want] - 1 }));
          setMoney(prev => prev + price);
          setReputation(prev => Math.min(prev + 0.8, 100));
          setStats(prev => ({ ...prev, totalSales: prev.totalSales + price }));
          addLog(`${customer.name}„Å´${itemData.name}„ÇíÂ£≤Âç¥„ÄÇÈáëË≤® ${price} Êûö„ÇíÂèó„ÅëÂèñ„Çä„Åæ„Åó„Åü„ÄÇ`, 'success');
        } else {
          setReputation(prev => Math.max(prev - 1.5, 0));
          addLog(`${customer.name}„ÅØ„Äå${itemData.name}„Äç„Åå„Å™„ÅÑ„Åì„Å®„Å´Â§±Êúõ„Åó„Å¶Â∏∞„Å£„Å¶„ÅÑ„Åç„Åæ„Åó„Åü...`, 'error');
        }
        setCustomerQueue(prev => prev.slice(1));
      }, 2000);
      return () => clearTimeout(timer);
    }
  }, [customerQueue, inventory, addLog]);

  // --- „Ç¢„ÇØ„Ç∑„Éß„É≥ ---
  const handleBuy = (itemId, amount) => {
    const cost = marketPrices[itemId] * amount;
    if (money >= cost) {
      setMoney(prev => prev - cost);
      setInventory(prev => ({ ...prev, [itemId]: prev[itemId] + amount }));
      addLog(`${RAW_MATERIALS.find(i => i.id === itemId).name} √ó${amount} „Çí‰ªïÂÖ•„Çå„Åæ„Åó„Åü„ÄÇ`, 'buy');
    } else {
      addLog('ÈáëË≤®„ÅåË∂≥„Çä„Åæ„Åõ„Çì„ÄÇÈ≠îÊ≥ï„Åß„ÇÇ„ÅäÈáë„ÅØÂ¢ó„ÇÑ„Åõ„Åæ„Åõ„Çì„Çà„ÄÇ', 'error');
    }
  };

  const handleCraft = (potionId) => {
    const potion = CRAFTED_ITEMS.find(p => p.id === potionId);
    let canCraft = true;
    Object.entries(potion.recipe).forEach(([ingId, count]) => {
      if ((inventory[ingId] || 0) < count) canCraft = false;
    });

    if (canCraft) {
      const newInv = { ...inventory };
      Object.entries(potion.recipe).forEach(([ingId, count]) => {
        newInv[ingId] -= count;
      });
      newInv[potionId] += 1;
      setInventory(newInv);
      setStats(prev => ({ ...prev, craftedCount: prev.craftedCount + 1 }));
      addLog(`Èå¨ÈáëÊàêÂäüÔºÅ ÂÆåÁíß„Å™„Äå${potion.name}„Äç„ÅÆÂÆåÊàê„Åß„Åô„ÄÇ`, 'craft');
    } else {
      addLog('Á¥†Êùê„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÂ∏ÇÂ†¥„Å∏Ë°å„Åç„Åæ„Åó„Çá„ÅÜ„ÄÇ', 'error');
    }
  };

  // --- „Éä„Éì„Ç¢„Ç§„ÉÜ„É† ---
  const NavItem = ({ id, label, icon: Icon }) => (
    <button
      onClick={() => setActiveTab(id)}
      className={`w-full flex items-center gap-4 py-4 px-6 transition-all relative ${
        activeTab === id 
        ? 'bg-amber-900 text-amber-100 shadow-lg' 
        : 'text-amber-900/60 hover:bg-amber-900/5'
      }`}
    >
      <Icon size={22} />
      <span className="font-cinzel font-bold tracking-widest text-sm">{label}</span>
      {activeTab === id && (
        <div className="absolute right-0 top-1/2 -translate-y-1/2 border-y-[12px] border-y-transparent border-r-[12px] border-r-[#fdfaf6]" />
      )}
    </button>
  );

  return (
    <div className="w-full min-h-screen bg-[#f4ece1] text-[#3e2723] flex overflow-hidden">
      {/* Â§ñÈÉ®„Éï„Ç©„É≥„Éà„ÅÆË™≠„ÅøËæº„Åø */}
      <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Quattrocento:wght@400;700&display=swap" rel="stylesheet" />
      
      {/* Áã¨Ëá™CSS„Çπ„Çø„Ç§„É´„ÅÆÊ≥®ÂÖ• */}
      <style>{`
        .font-cinzel { font-family: 'Cinzel', serif; }
        body { font-family: 'Quattrocento', serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d7ccc8; border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
      `}</style>

      {/* „Çµ„Ç§„Éâ„Éä„Éì */}
      <aside className="w-64 bg-[#efe2d0] border-r-4 border-[#3e2723] flex flex-col z-20 shadow-2xl">
        <div className="p-8 border-b-2 border-[#3e2723]/10 text-center">
          <h1 className="text-2xl font-black font-cinzel text-amber-900">ALCHEMY</h1>
          <p className="text-[10px] tracking-[0.3em] font-bold text-amber-800/40 uppercase">Atelier</p>
        </div>
        <nav className="flex-1 py-8">
          <NavItem id="shop" label="Shop Floor" icon={ShoppingBag} />
          <NavItem id="market" label="Guild Market" icon={ArrowRightLeft} />
          <NavItem id="alchemy" label="The Cauldron" icon={FlaskConical} />
          <NavItem id="stats" label="Ledger" icon={Scroll} />
        </nav>
        <div className="p-6 bg-amber-900/5 border-t-2 border-[#3e2723]/10">
          <div className="flex items-center gap-3 mb-2">
            <Coins className="text-amber-600" size={18} />
            <span className="font-cinzel font-bold text-lg">{money.toLocaleString()}</span>
          </div>
          <p className="text-[10px] font-bold text-amber-800/40 uppercase tracking-tighter">Gold Reserves</p>
        </div>
      </aside>

      {/* „É°„Ç§„É≥ */}
      <main className="flex-1 flex flex-col bg-[#fdfaf6] relative">
        <header className="h-20 border-b-2 border-[#3e2723]/10 flex items-center justify-between px-10 bg-white/50 backdrop-blur-sm z-10">
          <div className="flex items-center gap-8">
            <div className="flex items-center gap-2">
              <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">Day</span>
              <span className="text-2xl font-cinzel font-black text-amber-900">{day}</span>
            </div>
            <div className="flex items-center gap-2">
              <TrendingUp size={16} className="text-blue-500" />
              <span className="text-lg font-bold text-slate-700">{reputation.toFixed(0)}%</span>
            </div>
          </div>
          <button 
            onClick={() => setDay(d => d + 1)}
            className="flex items-center gap-3 bg-amber-900 text-amber-100 px-8 py-3 font-cinzel font-bold hover:bg-black transition-all shadow-lg"
          >
            Dawn of Next Day <ChevronRight size={18} />
          </button>
        </header>

        <div className="flex-1 overflow-y-auto p-10 custom-scrollbar">
          <div className="max-w-4xl mx-auto">
            {activeTab === 'shop' && (
              <div className="animate-in space-y-10">
                <div className="flex items-center justify-between border-b-2 border-amber-900/10 pb-4">
                  <h2 className="text-3xl font-cinzel font-bold">The Counter</h2>
                  <p className="text-sm italic text-amber-800/60">"ÂÜíÈô∫ËÄÖ„Åü„Å°„ÅØ„ÅÇ„Å™„Åü„ÅÆÁßòËñ¨„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô..."</p>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  {[...RAW_MATERIALS, ...CRAFTED_ITEMS].map(item => (
                    <div key={item.id} className="bg-white border-2 border-amber-100 p-6 shadow-sm hover:border-amber-400 transition-all group relative">
                      <div className="flex items-center gap-4 relative z-10">
                        <span className="text-5xl group-hover:scale-110 transition-transform">{item.icon}</span>
                        <div>
                          <p className="text-[10px] font-bold text-slate-400 uppercase">{item.name}</p>
                          <p className="text-3xl font-black font-cinzel text-slate-800">{inventory[item.id] || 0}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="space-y-4">
                  <h3 className="text-sm font-bold text-amber-900/40 uppercase tracking-[0.3em] flex items-center gap-2">
                    <User size={16} /> Travelers in Waiting
                  </h3>
                  {customerQueue.map((c, idx) => (
                    <div key={c.id} className={`p-5 bg-white border-l-8 shadow-sm flex justify-between items-center ${idx === 0 ? 'border-amber-600' : 'border-slate-200 opacity-40'}`}>
                      <div>
                        <span className="font-bold text-lg block">{c.name}</span>
                        <span className="text-[10px] text-slate-400 uppercase font-bold">Â∏åÊúõ„ÅÆÂìÅ„ÇíÊé¢Á¥¢‰∏≠...</span>
                      </div>
                      <div className="bg-amber-50 text-amber-900 px-4 py-1 rounded-sm border border-amber-100 font-bold flex items-center gap-2">
                        {[...RAW_MATERIALS, ...CRAFTED_ITEMS].find(i => i.id === c.want).icon} 
                        {[...RAW_MATERIALS, ...CRAFTED_ITEMS].find(i => i.id === c.want).name}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {activeTab === 'market' && (
              <div className="animate-in space-y-8">
                <h2 className="text-3xl font-cinzel font-bold border-b-2 border-amber-900/10 pb-4">Guild Market</h2>
                <div className="grid grid-cols-1 gap-4">
                  {RAW_MATERIALS.map(item => (
                    <div key={item.id} className="bg-white border-2 border-amber-50 p-6 flex items-center justify-between hover:shadow-xl transition-all">
                      <div className="flex items-center gap-6">
                        <div className="w-16 h-16 bg-amber-50 rounded-full flex items-center justify-center text-4xl">{item.icon}</div>
                        <div>
                          <p className="font-black text-2xl font-cinzel text-slate-800">{item.name}</p>
                          <span className="text-xl font-black text-amber-700 font-cinzel">Price: {marketPrices[item.id]}</span>
                        </div>
                      </div>
                      <div className="flex gap-4">
                        <button onClick={() => handleBuy(item.id, 1)} className="bg-slate-50 border p-4 font-bold px-8">√ó 1</button>
                        <button onClick={() => handleBuy(item.id, 10)} className="bg-amber-900 text-amber-100 p-4 font-bold px-8">√ó 10</button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {activeTab === 'alchemy' && (
              <div className="animate-in space-y-8">
                <h2 className="text-3xl font-cinzel font-bold border-b-2 border-amber-900/10 pb-4">Mystic Cauldron</h2>
                {CRAFTED_ITEMS.map(potion => {
                  const canCraft = Object.entries(potion.recipe).every(([id, count]) => inventory[id] >= count);
                  return (
                    <div key={potion.id} className={`p-8 border-2 ${canCraft ? 'bg-white border-indigo-200 shadow-lg' : 'bg-slate-50/50 opacity-60'}`}>
                      <div className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-6">
                          <span className="text-6xl">{potion.icon}</span>
                          <div>
                            <h3 className="font-bold text-2xl font-cinzel text-indigo-950">{potion.name}</h3>
                            <p className="text-sm italic text-slate-500">{potion.description}</p>
                          </div>
                        </div>
                        <button 
                          disabled={!canCraft}
                          onClick={() => handleCraft(potion.id)}
                          className={`px-12 py-4 font-cinzel font-bold ${canCraft ? 'bg-indigo-900 text-white shadow-[4px_4px_0px_#1e1b4b]' : 'bg-slate-200'}`}
                        >
                          Ë™øÂêà„ÇíÈñãÂßã
                        </button>
                      </div>
                      <div className="flex gap-3 pt-6 border-t border-indigo-50">
                        {Object.entries(potion.recipe).map(([ingId, count]) => (
                          <div key={ingId} className="text-xs font-bold px-4 py-2 bg-slate-50 rounded border">
                            {RAW_MATERIALS.find(r => r.id === ingId).name} √ó{count}
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}

            {activeTab === 'stats' && (
              <div className="animate-in space-y-12">
                <h2 className="text-3xl font-cinzel font-bold border-b-2 border-amber-900/10 pb-4">Business Ledger</h2>
                <div className="grid grid-cols-2 gap-8">
                  <div className="p-10 bg-white border-2 border-amber-100 shadow-xl">
                    <p className="text-xs font-bold text-amber-800/40 uppercase">Total Revenue</p>
                    <p className="text-5xl font-black font-cinzel text-amber-900">ÈáëË≤® {stats.totalSales}</p>
                  </div>
                  <div className="p-10 bg-white border-2 border-indigo-100 shadow-xl">
                    <p className="text-xs font-bold text-indigo-800/40 uppercase">Crafted Items</p>
                    <p className="text-5xl font-black font-cinzel text-indigo-900">{stats.craftedCount}</p>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </main>

      {/* Âè≥„É≠„Ç∞ */}
      <aside className="w-80 bg-[#efe2d0] border-l-4 border-[#3e2723] flex flex-col z-20">
        <div className="p-6 bg-[#3e2723] text-amber-100 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <History size={18} />
            <span className="font-cinzel font-bold text-sm tracking-widest">Chronicle</span>
          </div>
        </div>
        <div className="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar text-sm">
          {logs.map(log => (
            <div key={log.id} className="border-b border-[#3e2723]/5 pb-3">
              <span className="text-[9px] text-amber-800/40 font-bold">{log.time}</span>
              <p className={`font-medium ${log.type === 'error' ? 'text-red-600' : log.type === 'success' ? 'text-emerald-700' : 'text-[#3e2723]'}`}>
                {log.msg}
              </p>
            </div>
          ))}
        </div>
      </aside>
    </div>
  );
};

export default App;
